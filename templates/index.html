<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParGaMD Experiment Setup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            margin: 0 0.5rem;
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }
        .step.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .step.completed {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        .file-upload-area.dragover {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        .progress-container {
            margin-top: 2rem;
        }
        .terminal-window {
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
        }
        .config-preview {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 0.75rem;
            margin: 1rem 0;
        }
        .success-message {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 0.75rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">
                    <i class="fas fa-atom"></i> ParGaMD Experiment Setup
                </h1>
                
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" data-step="1">
                        <i class="fas fa-server"></i>
                        <div>System Setup</div>
                    </div>
                    <div class="step" data-step="2">
                        <i class="fas fa-dna"></i>
                        <div>Molecular System</div>
                    </div>
                    <div class="step" data-step="3">
                        <i class="fas fa-cogs"></i>
                        <div>WE Parameters</div>
                    </div>
                    <div class="step" data-step="4">
                        <i class="fas fa-microchip"></i>
                        <div>GPU Options</div>
                    </div>
                    <div class="step" data-step="5">
                        <i class="fas fa-eye"></i>
                        <div>Review & Generate</div>
                    </div>
                    <div class="step" data-step="6">
                        <i class="fas fa-terminal"></i>
                        <div>Monitor</div>
                    </div>
                </div>

                <!-- Error/Success Messages -->
                <div id="message-container"></div>

                <!-- Form Sections -->
                <form id="experiment-form">
                    <!-- Step 1: System Setup (SSH removed) -->
                    <div class="form-section active" id="step-1">
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-server"></i> System Setup</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="account" class="form-label">SLURM Account</label>
                                            <input type="text" class="form-control" id="account" name="account" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email for Notifications</label>
                                            <input type="email" class="form-control" id="email" name="email" required>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i>
                                            SSH and remote job submission are disabled in this build. You can still generate configuration files.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Molecular System -->
                    <div class="form-section" id="step-2">
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-dna"></i> Molecular System</h4>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="protein_name" class="form-label">Protein Name</label>
                                    <input type="text" class="form-control" id="protein_name" name="protein_name" 
                                           placeholder="e.g., chignolin" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>PDB File</h5>
                                        <div class="file-upload-area" id="pdb_upload_area">
                                            <i class="fas fa-file-upload fa-3x mb-3"></i>
                                            <p>Drag and drop your PDB file here or click to browse</p>
                                            <input type="file" id="pdb_file" name="pdb_file" accept=".pdb" style="display: none;">
                                            <button type="button" class="btn btn-primary" onclick="document.getElementById('pdb_file').click()">
                                                Browse Files
                                            </button>
                                        </div>
                                        <div id="pdb_file_info" class="mt-2"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>PRMTOP File</h5>
                                        <div class="file-upload-area" id="prmtop_upload_area">
                                            <i class="fas fa-file-upload fa-3x mb-3"></i>
                                            <p>Drag and drop your PRMTOP file here or click to browse</p>
                                            <input type="file" id="prmtop_file" name="prmtop_file" accept=".prmtop" style="display: none;">
                                            <button type="button" class="btn btn-primary" onclick="document.getElementById('prmtop_file').click()">
                                                Browse Files
                                            </button>
                                        </div>
                                        <div id="prmtop_file_info" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: WE Parameters -->
                    <div class="form-section" id="step-3">
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-cogs"></i> Weighted Ensemble Parameters</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Basic Parameters</h5>
                                        <div class="mb-3">
                                            <label for="bin_target_counts" class="form-label">Walkers per Bin</label>
                                            <input type="number" class="form-control" id="bin_target_counts" name="bin_target_counts" 
                                                   value="4" min="1" max="20" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="max_total_iterations" class="form-label">Maximum Iterations</label>
                                            <input type="number" class="form-control" id="max_total_iterations" name="max_total_iterations" 
                                                   value="1000" min="1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="nstlim" class="form-label">Number of MD Steps (nstlim)</label>
                                            <input type="number" class="form-control" id="nstlim" name="nstlim" 
                                                   value="50000" min="1000" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="ntpr" class="form-label">Print Frequency (ntpr)</label>
                                            <input type="number" class="form-control" id="ntpr" name="ntpr" 
                                                   value="500" min="100" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Progress Coordinate 1 (RMSD)</h5>
                                        <div class="mb-3">
                                            <label for="pc1_min" class="form-label">Minimum Value</label>
                                            <input type="number" class="form-control" id="pc1_min" name="pc1_min" 
                                                   value="0.0" step="0.1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="pc1_max" class="form-label">Maximum Value</label>
                                            <input type="number" class="form-control" id="pc1_max" name="pc1_max" 
                                                   value="8.0" step="0.1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="pc1_step" class="form-label">Step Size</label>
                                            <input type="number" class="form-control" id="pc1_step" name="pc1_step" 
                                                   value="0.2" step="0.1" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <h5>Progress Coordinate 2 (Radius of Gyration)</h5>
                                        <div class="mb-3">
                                            <label for="pc2_min" class="form-label">Minimum Value</label>
                                            <input type="number" class="form-control" id="pc2_min" name="pc2_min" 
                                                   value="0.0" step="0.1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="pc2_max" class="form-label">Maximum Value</label>
                                            <input type="number" class="form-control" id="pc2_max" name="pc2_max" 
                                                   value="8.0" step="0.1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="pc2_step" class="form-label">Step Size</label>
                                            <input type="number" class="form-control" id="pc2_step" name="pc2_step" 
                                                   value="0.2" step="0.1" required>
                                        </div>
                                        <div class="form-check form-switch mt-2">
                                            <input class="form-check-input" type="checkbox" id="include_infinite_bounds" checked>
                                            <label class="form-check-label" for="include_infinite_bounds">
                                                Include -inf and inf as outer bin boundaries
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: GPU Options -->
                    <div class="form-section" id="step-4">
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-microchip"></i> GPU Parallelization Options</h4>
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enable_gpu_parallelization" name="enable_gpu_parallelization">
                                    <label class="form-check-label" for="enable_gpu_parallelization">
                                        Enable Multi-GPU Parallelization
                                    </label>
                                </div>
                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Note:</strong> When enabled, the simulation will use multiple GPUs for parallel processing. 
                                    When disabled, the GPU parallelization code will be commented out to avoid errors on single-GPU systems.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: Review & Generate -->
                    <div class="form-section" id="step-5">
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-eye"></i> Review Configuration</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Configuration Summary</h5>
                                        <div id="config-summary"></div>
                                        
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-secondary" id="save-config-btn">
                                                <i class="fas fa-save"></i> Save Configuration
                                            </button>
                                            <button type="button" class="btn btn-info" id="load-config-btn">
                                                <i class="fas fa-folder-open"></i> Load Configuration
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Generated Files Preview</h5>
                                        <div class="mb-3">
                                            <label for="config-preview-select" class="form-label">Select File to Preview</label>
                                            <select class="form-select" id="config-preview-select">
                                                <option value="west.cfg">west.cfg</option>
                                                <option value="env.sh">env.sh</option>
                                                <option value="runseg.sh">runseg.sh</option>
                                                <option value="run_cmd.sh">run_cmd.sh</option>
                                                <option value="run_we.sh">run_we.sh</option>
                                            </select>
                                        </div>
                                        <div class="config-preview" id="config-preview" style="white-space: pre; font-family: monospace;"></div>
                                        <div class="mt-3">
                                            <button type="button" id="download-zip-btn" class="btn btn-outline-primary">
                                                <i class="fas fa-file-archive"></i> Download All as ZIP
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 6: Monitor -->
                    <div class="form-section" id="step-6">
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-terminal"></i> Experiment Monitoring</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h5>Job Status</h5>
                                        <div id="job-status" class="mb-3">
                                            <div class="alert alert-info">
                                                <i class="fas fa-clock"></i> Ready to start experiment
                                            </div>
                                        </div>
                                        
                                        <div class="progress-container" id="progress-container" style="display: none;">
                                            <h6>WE Simulation Progress</h6>
                                            <div class="progress mb-2">
                                                <div class="progress-bar" id="iteration-progress" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <small id="iteration-text">Iteration 0 / 0</small>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-secondary" id="start-experiment-btn">
                                                <i class="fas fa-play"></i> Start (disabled: SSH off)
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary" id="prev-btn" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="next-btn">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Configuration Modal -->
    <div class="modal fade" id="loadConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Load Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="config-id-input" class="form-label">Configuration ID</label>
                        <input type="text" class="form-control" id="config-id-input" placeholder="Enter configuration ID">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="load-config-confirm">Load</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="/static/js/main.js"></script>
</body>
</html>
